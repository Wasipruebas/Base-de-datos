<script>
  const q = document.getElementById("q");
  const out = document.getElementById("out");
  let productos = [];

  // Normaliza: minúsculas + sin tildes
  function norm(s){
    return (s ?? "")
      .toString()
      .toLowerCase()
      .trim()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  // Parser CSV que respeta comillas y comas dentro de campos
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' ) {
        // Doble comilla escapada ""
        if (inQuotes && next === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      }

      if (!inQuotes && (c === ",")) {
        row.push(cur);
        cur = "";
        continue;
      }

      if (!inQuotes && (c === "\n")) {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      if (c !== "\r") cur += c;
    }

    // último campo
    if (cur.length || row.length) {
      row.push(cur);
      rows.push(row);
    }

    return rows;
  }

  // Carga productos.csv
  fetch("productos.csv", { cache: "no-store" })
    .then(r => r.text())
    .then(text => {
      const table = parseCSV(text);
      const headers = table[0].map(h => h.trim());

      const idx = {
        codigo: headers.indexOf("Código"),
        producto: headers.indexOf("Producto"),
        uxb: headers.indexOf("UxB"),
        blister: headers.indexOf("Blister"),
        categoria: headers.indexOf("Categoría"),
      };

      productos = table.slice(1)
        .filter(r => r.length && (r[idx.producto] || "").trim() !== "")
        .map(r => ({
          codigo: (r[idx.codigo] ?? "").trim(),
          producto: (r[idx.producto] ?? "").trim(),
          uxb: (r[idx.uxb] ?? "").trim(),        // puede ser "6" o "6/8"
          blister: (r[idx.blister] ?? "").trim(),
          categoria: (r[idx.categoria] ?? "").trim(),
        }));
      
      out.innerHTML = `<b>Listo.</b> Cargados: <b>${productos.length}</b> productos.`;
    })
    .catch(err => {
      out.innerHTML = `<b>Error cargando productos.csv</b><div class="muted">${err}</div>`;
    });

  // Busca y muestra top 10
  q.addEventListener("input", () => {
    const term = norm(q.value);
    if(!term){
      out.textContent = "Esperando búsqueda…";
      return;
    }

    const res = productos
      .filter(p => norm(p.producto).includes(term))
      .slice(0, 10);

    if(!res.length){
      out.innerHTML = `<b>Sin resultados</b><div class="muted">Probá con otro nombre.</div>`;
      return;
    }

    out.innerHTML = res.map(p => `
      <div style="padding:12px 0;border-bottom:1px solid #eee">
        <div><b>${p.producto}</b></div>
        <div>Bulto (UxB): <b>${p.uxb || "-"}</b> ${p.uxb ? "unidades" : ""}</div>
        <div class="muted">Código: ${p.codigo || "-"} · Categoría: ${p.categoria || "-"}</div>
      </div>
    `).join("");
  });
</script>
